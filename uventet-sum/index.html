<!DOCTYPE html>
<html lang="nb">
<head>
  <meta charset="utf-8">
  <link rel="icon" type="image/svg+xml" href="../favicon.svg">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Fordel en uventet inntekt mellom sparing, gjeld og noe gøy.">
  <title>Uventet sum — Pengeprat</title>
  <link rel="stylesheet" href="../style.css">
</head>
<body>
  <div class="container">
    <div class="main-frame">

      <a href="../" class="back-link">← Pengeprat</a>
      <h1>Uventet sum</h1>
      <p style="margin-bottom: var(--space-6);">
        Fått inn penger utenom det vanlige? Bruk sliderne til å fordele beløpet mellom ulike kategorier.
      </p>

      <section class="section">
        <h3>Beløp</h3>
        <div class="field-group">
          <label for="amount">Hvor mye har du fått?</label>
          <input id="amount" type="number" min="0" step="1000" placeholder="f.eks. 50000">
        </div>
        <div class="field-group">
          <label for="source">Kilde (valgfritt)</label>
          <input id="source" type="text" placeholder="f.eks. bonus, arv, skatteoppgjør">
        </div>
      </section>

      <section class="section">
        <h3>Fordeling</h3>
        <div id="bar-wrap"></div>
        <div id="kategori-liste"></div>
        <div style="margin-top: var(--space-3);">
          <button id="legg-til-btn">+ Legg til kategori</button>
        </div>
      </section>

      <section class="section" id="oppsummering-section" style="display: none;">
        <h3>Oppsummering</h3>
        <div class="result-card" id="oppsummering-innhold"></div>
      </section>

      <div style="margin-top: var(--space-6);">
        <button class="danger" id="slett-btn">Slett mine data</button>
      </div>

      <div class="privacy-notice">
        <p>Dataene dine lagres kun lokalt i nettleseren din. Ingenting sendes til noen server.</p>
      </div>

    </div>
  </div>

  <script>
    const STORAGE_KEY = 'pengeprat_uventet_sum';

    const COLORS = [
      '#6a9fb5', '#7ab56a', '#b5916a', '#b56a8a', '#8a6ab5', '#6ab5a5',
    ];

    const DEFAULT_CATEGORIES = [
      { id: 'buffer',  name: 'Nødfond / buffer',     percent: 30, color: COLORS[0] },
      { id: 'gjeld',   name: 'Nedbetale gjeld',       percent: 20, color: COLORS[1] },
      { id: 'sparing', name: 'Langsiktig sparing',    percent: 30, color: COLORS[2] },
      { id: 'gøy',     name: 'Noe gøy',               percent: 20, color: COLORS[3] },
    ];

    function lastState() {
      try {
        const lagret = localStorage.getItem(STORAGE_KEY);
        if (lagret) return JSON.parse(lagret);
      } catch {}
      return { amount: 0, source: '', categories: klonaKategorier() };
    }

    function lagreState() {
      try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch {}
    }

    function klonaKategorier() {
      return DEFAULT_CATEGORIES.map(k => ({ ...k }));
    }

    function formatKr(n) {
      return Math.round(n).toLocaleString('nb-NO') + ' kr';
    }

    function genId() {
      return Math.random().toString(36).slice(2, 9);
    }

    function esc(s) {
      return String(s)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;');
    }

    // Når én slider flyttes, fordeles resten proporsjonalt
    function normaliserProsenter(endretId, nyProsent) {
      const andre = state.categories.filter(k => k.id !== endretId);
      const andreTotal = andre.reduce((s, k) => s + k.percent, 0);
      const gjenværende = 100 - nyProsent;

      state.categories = state.categories.map(k => {
        if (k.id === endretId) return { ...k, percent: nyProsent };
        if (andreTotal === 0) return { ...k, percent: Math.round(gjenværende / andre.length) };
        return { ...k, percent: Math.round(gjenværende * (k.percent / andreTotal)) };
      });
    }

    // --- State ---
    let state = lastState();

    // --- DOM-refs ---
    const amountInput    = document.getElementById('amount');
    const sourceInput    = document.getElementById('source');
    const barWrap        = document.getElementById('bar-wrap');
    const kategoriListe  = document.getElementById('kategori-liste');
    const leggTilBtn     = document.getElementById('legg-til-btn');
    const slettBtn       = document.getElementById('slett-btn');
    const oppSeksjon     = document.getElementById('oppsummering-section');
    const oppInnhold     = document.getElementById('oppsummering-innhold');

    // --- Startverdi på inputs ---
    amountInput.value = state.amount || '';
    sourceInput.value = state.source || '';

    // --- Statiske lyttere ---
    amountInput.addEventListener('input', () => {
      state.amount = Number(amountInput.value) || 0;
      lagreState();
      render();
    });

    sourceInput.addEventListener('input', () => {
      state.source = sourceInput.value;
      lagreState();
    });

    leggTilBtn.addEventListener('click', () => {
      state.categories.push({
        id:      genId(),
        name:    '',
        percent: 0,
        color:   COLORS[state.categories.length % COLORS.length],
      });
      lagreState();
      render();
    });

    slettBtn.addEventListener('click', () => {
      state = { amount: 0, source: '', categories: klonaKategorier() };
      localStorage.removeItem(STORAGE_KEY);
      amountInput.value = '';
      sourceInput.value = '';
      render();
    });

    // --- Render ---
    function render() {
      renderBar();
      renderKategorier();
      renderOppsummering();
    }

    function renderBar() {
      if (state.amount <= 0) { barWrap.innerHTML = ''; return; }
      const segmenter = state.categories
        .map(k => `<div class="bar-segment" style="width:${k.percent}%;background:${k.color};"></div>`)
        .join('');
      barWrap.innerHTML = `<div class="bar-container" style="margin-bottom:var(--space-5);">${segmenter}</div>`;
    }

    function renderKategorier() {
      kategoriListe.innerHTML = state.categories.map(k => `
        <div class="goal-item" data-id="${k.id}">
          <div class="goal-header">
            <div style="display:flex;align-items:center;gap:var(--space-2);flex:1;">
              <div style="width:10px;height:10px;border-radius:50%;background:${k.color};flex-shrink:0;"></div>
              <input
                type="text"
                class="kat-navn"
                data-id="${k.id}"
                placeholder="Kategorinavn"
                value="${esc(k.name)}"
                style="background:transparent;border:none;color:var(--text);font-family:var(--font);font-size:0.85rem;font-weight:500;padding:0;outline:none;flex:1;"
              >
            </div>
            <button class="goal-remove kat-fjern" data-id="${k.id}">fjern</button>
          </div>
          <div style="display:flex;align-items:center;gap:var(--space-4);margin-top:var(--space-2);">
            <input
              type="range"
              class="kat-slider"
              data-id="${k.id}"
              min="0" max="100"
              value="${k.percent}"
              style="flex:1;"
            >
            <span style="font-size:0.8rem;color:var(--text-secondary);min-width:36px;text-align:right;">${k.percent}%</span>
          </div>
          ${state.amount > 0
            ? `<div style="margin-top:var(--space-2);font-size:0.75rem;color:var(--text-muted);">= ${formatKr(state.amount * k.percent / 100)}</div>`
            : ''}
        </div>
      `).join('');

      // Koblinger til dynamisk genererte elementer
      kategoriListe.querySelectorAll('.kat-navn').forEach(input => {
        input.addEventListener('input', e => {
          const kat = state.categories.find(k => k.id === e.target.dataset.id);
          if (kat) kat.name = e.target.value;
          lagreState();
        });
      });

      kategoriListe.querySelectorAll('.kat-slider').forEach(slider => {
        slider.addEventListener('input', e => {
          normaliserProsenter(e.target.dataset.id, Number(e.target.value));
          lagreState();
          render();
        });
      });

      kategoriListe.querySelectorAll('.kat-fjern').forEach(btn => {
        btn.addEventListener('click', e => {
          const gjenværende = state.categories.filter(k => k.id !== e.target.dataset.id);
          if (gjenværende.length === 0) return;
          const total = gjenværende.reduce((s, k) => s + k.percent, 0);
          state.categories = total === 0
            ? gjenværende.map(k => ({ ...k, percent: Math.round(100 / gjenværende.length) }))
            : gjenværende.map(k => ({ ...k, percent: Math.round(k.percent * (100 / total)) }));
          lagreState();
          render();
        });
      });
    }

    function renderOppsummering() {
      if (state.amount <= 0) { oppSeksjon.style.display = 'none'; return; }
      oppSeksjon.style.display = '';

      const rader = state.categories
        .filter(k => k.percent > 0)
        .map(k => `
          <div class="result-row">
            <span class="result-label">${esc(k.name) || 'Uten navn'}</span>
            <span class="result-value">${formatKr(state.amount * k.percent / 100)}</span>
          </div>
        `).join('');

      oppInnhold.innerHTML = rader + `
        <div class="result-row" style="border-top:1px solid var(--border);margin-top:var(--space-2);padding-top:var(--space-3);">
          <span class="result-label">Totalt</span>
          <span class="result-value accent">${formatKr(state.amount)}</span>
        </div>
      `;
    }

    render();
  </script>
</body>
</html>
